<div class="api-key-bar" style="position:fixed;top:0;left:0;width:100vw;z-index:2000;background:#fff;padding:8px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.07);display:flex;align-items:center;gap:12px;">
  <label for="apiKeyInput">OpenAI API Key:</label>
  <input id="apiKeyInput" [type]="showKey ? 'text' : 'password'" [(ngModel)]="apiKey" (ngModelChange)="setApiKey($event)" style="width:320px;" placeholder="sk-..." />
  <button type="button" (click)="showKey = !showKey">{{ showKey ? 'Hide' : 'Show' }}</button>
  <span *ngIf="!apiKey" style="color:#c00;font-weight:bold;">Please enter your OpenAI API key to use chat.</span>
</div>
<div class="branching-chat-container" [style.marginTop.px]="48">
  <!-- Save/Load Controls -->
  <div class="canvas-controls">
    <button class="canvas-btn" (click)="saveCanvas()" title="Save Canvas">ğŸ’¾ Save</button>
    <button class="canvas-btn" (click)="loadCanvasInput.click()" title="Load Canvas">ğŸ“‚ Load</button>
    <button class="canvas-btn new-root-btn" (click)="createNewRoot()" title="New Root"> New Root</button>
    <button class="canvas-btn" (click)="newCanvas()" title="New Canvas">ğŸ§¹ New Canvas</button>
    <button class="canvas-btn" (click)="centerAll()" title="Center All">ğŸ¯ Center All</button>
    <input type="file" #loadCanvasInput style="display:none" (change)="loadCanvas($event)">
  </div>

  <!-- Zoom Controls -->
  <div class="zoom-controls">
    <button class="zoom-btn" (click)="zoomIn()" title="Zoom In">+</button>
    <button class="zoom-btn" (click)="zoomOut()" title="Zoom Out">-</button>
  </div>

  <!-- Canvas Background -->
  <div class="canvas-bg"></div>

  <!-- Canvas -->
  <div 
    #canvas
    class="canvas" 
    (mousedown)="onMouseDown($event)"
    (mousemove)="onMouseMove($event)"
    (mouseup)="onMouseUp()"
    (wheel)="onWheel($event)"
    [style.transform]="'translate(' + canvasOffset.x + 'px, ' + canvasOffset.y + 'px) scale(' + zoom + ')'"
    [style.transform-origin]="'0 0'">
    
    <!-- Debug: Show canvas center (0,0) -->
    <div class="canvas-center-dot"></div>

    <!-- SVG for connecting lines -->
    <svg class="connections" width="100%" height="100%">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
        </marker>
      </defs>
      <g>
        <ng-container *ngFor="let node of getAllNodes()">
          <ng-container *ngFor="let child of node.children">
            <path
              [attr.d]="
                'M ' + (node.x + node.width / 2) + ' ' + (node.y + node.height) +
                ' C ' + (node.x + node.width / 2) + ' ' + (node.y + node.height + 40) + ', ' +
                (child.x + child.width / 2) + ' ' + (child.y - 40) + ', ' +
                (child.x + child.width / 2) + ' ' + child.y
              "
              stroke="#666"
              stroke-width="2"
              fill="none"
              marker-end="url(#arrowhead)" />
          </ng-container>
        </ng-container>
      </g>
    </svg>

    <!-- Chat Nodes -->
    <div 
      *ngFor="let node of getAllNodes()"
      class="chat-node"
      [class.active]="node.active"
      [class.loading]="node.loading"
      [class.root-debug]="node.id === rootNode?.id"
      [style.left.px]="node.x"
      [style.top.px]="node.y"
      [style.width.px]="node.width"
      [style.height.px]="node.height">
      
      <!-- Drag Handle -->
      <div class="drag-handle" (mousedown)="onNodeMouseDown($event, node)">
        <div class="node-title" 
             *ngIf="!editingNode || editingNode.id !== node.id"
             (dblclick)="startEditing(node)"
             [style.fontSize.px]="20 / zoom">
          {{ node.title || 'Chat ' + node.id.slice(0, 8) }}
        </div>
        <input 
          *ngIf="editingNode && editingNode.id === node.id"
          class="title-input"
          [value]="editingName"
          (input)="onTitleInput($event)"
          (blur)="finishEditing()"
          (keyup.enter)="finishEditing()"
          (keyup.escape)="cancelEditing()"
          #titleInput
          autofocus
          [style.fontSize.px]="20 / zoom">
        <div class="node-actions">
          <button class="action-btn" (click)="branch(node)" [disabled]="node.loading" title="Branch Chat">ğŸŒ¿</button>
          <button class="action-btn" (click)="startEditing(node)" title="Edit Name">âœï¸</button>
          <button class="action-btn delete-btn" (click)="deleteNode(node)" title="Delete Node">ğŸ—‘ï¸</button>
        </div>
      </div>

      <!-- Chat Content -->
      <div class="chat-content">
        <div class="messages" #messagesContainer>
          <div *ngFor="let message of node.messages" class="message" [class.user]="message.role === 'user'">
            <div class="message-content" [innerHTML]="formatMessage(message.content)"></div>
          </div>
          <div *ngIf="node.loading" class="message assistant">
            <div class="message-content">
              <span class="typing-indicator">â—</span>
            </div>
          </div>
        </div>
        
        <!-- Input Area -->
        <div class="input-area">
          <textarea 
            [(ngModel)]="node.input"
            (keydown.enter)="sendMessage(node, $event)"
            placeholder="Type your message..."
            [disabled]="!node.active || node.loading"
            rows="2">
          </textarea>
          <button 
            (click)="sendMessage(node)"
            [disabled]="!node.input.trim() || !node.active || node.loading">
            Send
          </button>
        </div>
      </div>

      <!-- Resize Handle -->
      <div class="resize-handle" (mousedown)="onResizeMouseDown($event, node)"></div>
    </div>
  </div>
</div>
